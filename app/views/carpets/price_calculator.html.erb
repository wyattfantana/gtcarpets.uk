<!-- Hide the calculator form after calculating the total -->
<% unless @total_cost %>
  <%= form_with url: '/carpet_price_calculator', method: :post, local: true do %>
    <div>
      <label for="length">Room Length (in meters):</label>
      <%= number_field_tag :length, nil, placeholder: "Enter length", required: true %>
    </div>

    <div>
      <label for="width">Room Width (in meters):</label>
      <%= number_field_tag :width, nil, placeholder: "Enter width", required: true %>
    </div>

    <div>
      <label for="cost_per_meter">Carpet Cost per square meter (£):</label>
      <%= number_field_tag :cost_per_meter, nil, placeholder: "Enter cost per sq meter", required: true %>
    </div>

    <!-- Dropdown for Underlay -->
    <div>
      <label for="underlay">Do you need underlay?</label>
      <%= select_tag :underlay, options_for_select([['Yes', 'yes'], ['No', 'no']]), prompt: 'Select option', required: true %>
    </div>

    <!-- Dropdown for Gripper Rods -->
    <div>
      <label for="gripper_rods">Number of Gripper Rod Boxes:</label>
      <%= number_field_tag :gripper_rods, 1, min: 0, step: 1, required: true %>
    </div>

    <div>
      <%= submit_tag "Calculate" %>
    </div>
  <% end %>
<% end %>

<!-- Show the result and the contact form when the total cost is calculated -->
<% if @total_cost %>
  <% 
    # Internal values
    fitting_cost = 15 # Fixed fitting cost per sqm
    underlay_cost = params[:underlay] == 'yes' ? 5 : 0 # Underlay fixed at £5 per sqm
    gripper_rod_price = 10 # Fixed price per box of gripper rods
    gripper_boxes = params[:gripper_rods].to_i # Number of gripper rods
    
    # Calculate the area
    area = params[:length].to_f * params[:width].to_f
    
    # Total carpet cost
    carpet_cost = area * params[:cost_per_meter].to_f
    
    # Total fitting cost
    total_fitting_cost = area * fitting_cost
    
    # Total gripper rods cost
    total_gripper_rod_cost = gripper_boxes * gripper_rod_price
    
    # Total underlay cost
    total_underlay_cost = area * underlay_cost
    
    # Final total cost
    final_total_cost = carpet_cost + total_fitting_cost + total_gripper_rod_cost + total_underlay_cost
    
    # Format the cost without decimals if the value is an integer
    formatted_cost = final_total_cost == final_total_cost.to_i ? number_with_delimiter(final_total_cost.to_i, delimiter: ',') : number_with_delimiter(final_total_cost.round(2), delimiter: ',')
  %>

  <div id="calculator-result">
    <p><strong>For <%= area.round(2) %> sqm of carpet fitted, @£<%= fitting_cost %> per meter fitting cost, including underlay @£5 per sqm, plus <%= gripper_boxes %> box(es) of gripper rods, the total cost is £<%= formatted_cost %>.</strong></p>
    <p>If you would like to book us to fit your carpets, please use the contact form below. We look forward to working with you!</p>
  </div>

  <!-- Contact form -->
  <section id="contact">
    <div class="container">
        <h2>Contact Us</h2>
        <p>Ready to get started? Contact us today!</p>
        <%= form_with model: @contact, url: contacts_path, id: "contact-form" do |form| %>
            <div>
                <%= form.label :name %>
                <%= form.text_field :name, required: true %>
            </div>
            <div>
                <%= form.label :email %>
                <%= form.email_field :email, required: true %>
            </div>
            <div>
                <%= form.label :message %>
                <%= form.text_area :message, rows: 4, required: true %>
            </div>
            <div>
                <%= form.submit "Send", class: "btn btn-primary" %>
            </div>
        <% end %>
    </div>
  </section>
<% end %>